trigger:
  branches:
    include:
      - master

pool:
  vmImage: ubuntu-latest

jobs:
  - job: build
    steps:
    - task: UseRubyVersion@0
      inputs:
        versionSpec: '~>2.6'
    - script: |
        gem install bundler
        bundle install
      displayName: 'Install Dependencies'
    - script: |
        bundle exec jekyll build
      displayName: 'Jekyll Build'
    - script: |
        bundle exec htmlproofer --empty-alt-ignore --disable-external ./_site
      displayName: 'HTML Proofer'
    - script: tar -cvzf "$(Pipeline.Workspace)/site.tar.gz" _site/
      displayName: "Compress Artifacts"
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/site.tar.gz'
        artifact: 'site_archive'
        publishLocation: 'pipeline'
  - job: deploy
    dependsOn:
      - build
    condition: and(eq(variables['Build.SourceBranch'], 'refs/heads/master'), succeeded())
    steps:
      - script: |
          git worktree add gh-pages gh-pages
        displayName: "Setup gh-pages worktree"
      - task: DownloadBuildArtifacts@0
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'site_archive'
          downloadPath: '$(System.ArtifactsDirectory)'
      - task: DownloadSecureFile@1
        inputs:
          secureFile: 'deploy_key'
      - script: |
          mkdir ~/.ssh && mv $DOWNLOADSECUREFILE_SECUREFILEPATH ~/.ssh/id_rsa
          chmod 700 ~/.ssh && chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
          git config --local user.name "Azure Pipelines"
          git config --local user.email "azuredevops@microsoft.com"
          git remote set-url origin git@github.com:kateescott/kateescott.com.git
        displayName: 'Setup Deploy Environment'
      - script: |
          set -eux
          echo "$(System.ArtifactsDirectory)"
          find "$(System.ArtifactsDirectory)"
          find . \! -name '.git' -delete
          tar -xvf "$(System.ArtifactsDirectory)/site.tar.gz" -C gh-pages  --strip-components 1
          git status
          git add -A
          git commit -m "$(Build.SourceVersionMessage)"
          git push origin gh-pages
        workingDirectory: 'gh-pages'
      - script: |
          rm ~/.ssh/id_rsa
        displayName: 'Cleanup Deploy Environment'
